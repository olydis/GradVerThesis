\begin{lemma}[Composability of Deterministic Lifting]~\\
    \label{lemma:det-lift-comp}
    Let $\dgrad{P_1}, \dgrad{P_2}$ be sound deterministic liftings of predicates $P_1, P_2$.
    Let $P_2$ be monotonic w.r.t. implication in its first parameter.
    Then
    \begin{displaymath}
    \dgrad{P_3} ~~\defeq~~ \dgrad{P_2} \circ \dgrad{P_1}
    \end{displaymath}
    is a sound deterministic lifting of $P_3(\phi_1, \phi_3) = \exists \phi_2.~ P_1(\phi_1, \phi_2) \wedge P_2(\phi_2, \phi_3)$.
\end{lemma}
\begin{proof}~
    \begin{description}
        \item[Introduction]
        \begin{align*}
        & \phantom{\overset{}{~\quad\quad\implies\quad\quad~}}~
        P_3(\phi_1, \phi_3)\\
        & \overset{}{~\quad\quad\implies\quad\quad~} 
        \exists \phi_2.~ P_1(\phi_1, \phi_2) \wedge P_2(\phi_2, \phi_3)\\
        & \overset{Introduction}{~\quad\quad\implies\quad\quad~} 
        \exists \phi_2.~ P_1(\phi_1, \phi_2) \wedge P_2(\phi_2, \phi_3)
        \wedge (\exists \grad{\phi_2}.~ \dgrad{P_1}(\phi_1) = \grad{\phi_2})\\
        & \overset{Strength}{~\quad\quad\implies\quad\quad~} 
        \exists \phi_2.~ P_1(\phi_1, \phi_2) \wedge P_2(\phi_2, \phi_3)
        \wedge (\exists \grad{\phi_2}.~ \dgrad{P_1}(\phi_1) = \grad{\phi_2} \\
        & \quad\quad\quad\quad\quad\quad\quad\quad\quad\quad\quad\quad\quad\quad
        \wedge 
        (\exists \phi_2' \in \gamma(\grad{\phi_2}).~ \phiImplies{\phi_2'}{\phi_2}))\\
        & \overset{lemma~\ref{ass:hl-mono}}{~\quad\quad\implies\quad\quad~} 
        \exists \phi_2.~ P_1(\phi_1, \phi_2) \wedge P_2(\phi_2, \phi_3)
        \wedge (\exists \grad{\phi_2}.~ \dgrad{P_1}(\phi_1) = \grad{\phi_2} \\
        & \quad\quad\quad\quad\quad\quad\quad\quad\quad\quad\quad\quad\quad\quad
        \wedge 
        (\exists \phi_2' \in \gamma(\grad{\phi_2}), \phi_3'.~ \phiImplies{\phi_2'}{\phi_2} \wedge P_2(\phi_2', \phi_3')))\\
        & \overset{}{~\quad\quad\implies\quad\quad~} 
        \exists \grad{\phi_2}.~ \dgrad{P_1}(\phi_1) = \grad{\phi_2} \wedge 
        (\exists \phi_2' \in \gamma(\grad{\phi_2}), \phi_3'.~ P_2(\phi_2', \phi_3'))\\
        & \overset{Introduction}{~\quad\quad\implies\quad\quad~} 
        \exists \grad{\phi_2}.~ \dgrad{P_1}(\phi_1) = \grad{\phi_2} \wedge 
        (\exists \phi_2' \in \gamma(\grad{\phi_2}), \grad{\phi_3'}.~ \dgrad{P_2}(\phi_2') = \grad{\phi_3'})\\
        & \overset{Monotonicity}{~\quad\quad\implies\quad\quad~} 
        \exists \grad{\phi_2}.~ \dgrad{P_1}(\phi_1) = \grad{\phi_2} \wedge 
        (\exists \grad{\phi_3}.~ \dgrad{P_2}(\grad{\phi_2}) = \grad{\phi_3})\\
        & \overset{}{~\quad\quad\implies\quad\quad~} 
        \exists \grad{\phi_3}.~ \dgrad{P_2}(\dgrad{P_1}(\phi_1)) = \grad{\phi_3}\\
        & \overset{}{~\quad\quad\implies\quad\quad~} 
        \exists \grad{\phi_3}.~ \dgrad{P_3}(\phi_1) = \grad{\phi_3}
        \end{align*}
        
        \item[Strength]
        \begin{align*}
        & \phantom{\overset{}{~\quad\quad\implies\quad\quad~}}~
        \dgrad{P_3}(\grad{\phi_1}) = \grad{\phi_3} \wedge \phi_1 \in \gamma(\grad{\phi_1}) \wedge P_3(\phi_1, \phi)\\
        & \overset{Defenitions}{~\quad\quad\implies\quad\quad~} 
        \exists \grad{\phi_2}, \phi'.~ 
        \dgrad{P_1}(\grad{\phi_1}) = \grad{\phi_2} \wedge \dgrad{P_2}(\grad{\phi_2}) = \grad{\phi_3} \wedge 
        \phi_1 \in \gamma(\grad{\phi_1}) \\
        & \quad\quad\quad\quad\quad\quad\quad\quad\quad\quad
        \wedge P_1(\phi_1, \phi') \wedge P_2(\phi', \phi)\\
        & \overset{Strength}{~\quad\quad\implies\quad\quad~} 
        \exists \grad{\phi_2}, \phi'.~ 
        \dgrad{P_1}(\grad{\phi_1}) = \grad{\phi_2} \wedge \dgrad{P_2}(\grad{\phi_2}) = \grad{\phi_3} \wedge 
        \phi_1 \in \gamma(\grad{\phi_1}) \\
        & \quad\quad\quad\quad\quad\quad\quad\quad\quad\quad
         \wedge P_1(\phi_1, \phi') \wedge P_2(\phi', \phi)
        \wedge (\exists \phi_2 \in \gamma(\grad{\phi_2}).~ P_1(\phi_1, \phi_2) \wedge \phiImplies{\phi_2}{\phi'}) \\
        & \overset{}{~\quad\quad\implies\quad\quad~} 
        \exists \grad{\phi_2}, \phi', \phi_2 \in \gamma(\grad{\phi_2}).~ 
        \dgrad{P_1}(\grad{\phi_1}) = \grad{\phi_2} \wedge \dgrad{P_2}(\grad{\phi_2}) = \grad{\phi_3} \wedge 
        \phi_1 \in \gamma(\grad{\phi_1}) \\
        & \quad\quad\quad\quad\quad\quad\quad\quad\quad\quad
        \wedge P_1(\phi_1, \phi_2) \wedge P_2(\phi', \phi)
        \wedge \phiImplies{\phi_2}{\phi'} \\
        & \overset{}{~\quad\quad\implies\quad\quad~} 
        \exists \grad{\phi_2}, \phi', \phi_2 \in \gamma(\grad{\phi_2}).~ 
        \dgrad{P_2}(\grad{\phi_2}) = \grad{\phi_3}  \\
        & \quad\quad\quad\quad\quad\quad\quad\quad\quad\quad
        \wedge P_1(\phi_1, \phi_2) \wedge P_2(\phi', \phi)
        \wedge \phiImplies{\phi_2}{\phi'} \\
        & \overset{lemma~\ref{ass:hl-mono}}{~\quad\quad\implies\quad\quad~} 
        \exists \grad{\phi_2}, \phi_2 \in \gamma(\grad{\phi_2}), \phi''.~ 
        \dgrad{P_2}(\grad{\phi_2}) = \grad{\phi_3}   \\
        & \quad\quad\quad\quad\quad\quad\quad\quad\quad\quad
        \wedge P_1(\phi_1, \phi_2) \wedge P_2(\phi_2, \phi'')
        \wedge \phiImplies{\phi''}{\phi} \\
        & \overset{Strength}{~\quad\quad\implies\quad\quad~} 
        \exists \grad{\phi_2}, \phi_2 \in \gamma(\grad{\phi_2}), \phi''.~ 
        \dgrad{P_2}(\grad{\phi_2}) = \grad{\phi_3}  \\
        & \quad\quad\quad\quad\quad\quad\quad\quad\quad\quad
        \wedge P_1(\phi_1, \phi_2) \wedge P_2(\phi_2, \phi'') 
        \wedge \phiImplies{\phi''}{\phi}  \\
        & \quad\quad\quad\quad\quad\quad\quad\quad\quad\quad
        \wedge (\exists \phi_3 \in \gamma(\grad{\phi_3}).~ P_2(\phi_2, \phi_3) \wedge \phiImplies{\phi_3}{\phi''}) \\
        & \overset{}{~\quad\quad\implies\quad\quad~} 
        \exists \phi_2 \in \gamma(\grad{\phi_2}), \phi_3 \in \gamma(\grad{\phi_3}).~ 
        P_1(\phi_1, \phi_2) \wedge P_2(\phi_2, \phi_3)
        \wedge \phiImplies{\phi_3}{\phi} \\
        & \overset{Defenition}{~\quad\quad\implies\quad\quad~} 
        \exists \phi_3 \in \gamma(\grad{\phi_3}).~ 
        P_3(\phi_1, \phi_3)
        \wedge \phiImplies{\phi_3}{\phi} 
        \end{align*}
        
        \item[Monotonicity]~\\
        Compositions of monotonic functions are monotonic.
    \end{description}
\end{proof}
In other words, deterministic liftings of composite predicates can be obtained by composing piecewise deterministic liftings.
Optimality of the piecewise liftings does not guarantee optimality of the overall lifting. % double release

We further demonstrate deterministic lifting by means of the following Hoare rules:
\begin{mathpar}
    \inferrule* [right=HSeq]
    {
        \phiImplies{\phi_{q1}} {\phi_{q2}} \\\\
        \thoare {} {\phi_p} {{s_1}} {\phi_{q1}} \\
        \thoare {} {\phi_{q2}} {{s_2}} {\phi_r}
    }
    {
        \thoare {} {\phi_p} {\sSeq{$s_1$}{$s_2$}} {\phi_r}
    }
    
    \inferrule* [Right=HAssign]
    {
        ~
    }
    {
        \thoare {} {\phi[e/x]} {\sVarAssign{$x$}{$e$}} {\phi}
    }
\end{mathpar}

Note that gradual liftings of these rules can be found in section \ref{ssec:the-problem-with}, where we demonstrated the problems that ultimately lead to deterministic liftings.

We start by lifting implication, which is used in \tset{HSeq}.
\begin{lemma}[Optimal Deterministic Lifting of Implication]~\\
    \label{lemma:opt-lift-impl}
    Let $\id : \setGFormula \rightarrow \setGFormula$ be the identity function.
    Then $\id$ is an optimal deterministic lifting of $\phiImplies{\cdot}{\cdot} \subseteq \setFormula \times \setFormula$.
\end{lemma}
\begin{proof}~
    \begin{description}
        \item[Soundness]
        \begin{description}
            \item[Introduction] The identity function is total.
            
            \item[Strength]~\\
            Known:
            $$\id(\grad{\phi_1}) = \grad{\phi_2} \wedge \phi_1 \in \gamma(\grad{\phi_1}) \wedge \phiImplies{\phi_1}{\phi}$$
            Goal:
            $$\exists \phi_2 \in \gamma(\grad{\phi_2}).~ \phiImplies{\phi_1}{\phi_2} \wedge \phiImplies{\phi_2}{\phi}$$
            The goal is satisfied when choosing $\phi_2 = \phi_1$
            
            \item[Monotonicity] Trivial.
        \end{description}
        \item[Optimality]~\\
        Proof by contradiction.
        
        Assume there was another, more optimal deterministic lifting $\dgrad{f} : \setGFormula \rightarrow \setGFormula$.
        Note that $\dgrad{f}$ must be total as it would otherwise not satisfy the introduction rule.
        Let $\grad{\phi} \in \setGFormula$ be a chosen such that $\dgrad{f}(\grad{\phi}) \sqsubset \id(\grad{\phi})$ (exists, since $\dgrad{f}$ is more optimal).
        
        Then there exists $\phi \in (\gamma(\id(\grad{\phi})) \backslash \gamma(\dgrad{f}(\grad{\phi}))$, i.e. $\phi \in (\gamma(\grad{\phi}) \backslash \gamma(\dgrad{f}(\grad{\phi}))$.
        Applying the strength rule to $\dgrad{f}$ and $\phiImplies{\phi}{\phi}$ we can deduce
        $$\exists \phi' \in \gamma(\dgrad{f}(\grad{\phi})).~ \phiImplies{\phi}{\phi'} ~\wedge~ \phiImplies{\phi'}{\phi}$$
        This means that $\phi \in \gamma(\dgrad{f}(\grad{\phi}))$.
        Contradiction.
    \end{description}
\end{proof}

Using lemma \ref{lemma:det-lift-comp} and lemma \ref{lemma:opt-lift-impl}, the deterministic lifting of \tset{HSeq} reduces to
\begin{mathpar}
    \inferrule* [right=DGHSeq]
    {
        \dgthoare {} {\grad{\phi_p}} {\grad{s_1}} {\grad{\phi_q}} \\
        \dgthoare {} {\grad{\phi_q}} {\grad{s_2}} {\grad{\phi_r}}
    }
    {
        \dgthoare {} {\grad{\phi_p}} {\sSeq{$\grad{s_1}$}{$\grad{s_2}$}} {\grad{\phi_r}}
    }
\end{mathpar}
Note that we used inductive notation to define a function -- there are no free variables, i.e. the rule is syntax-directed.

For the assignment rule we can derive
\begin{mathpar}
    \inferrule* [right=DGHAssign1]
    {
        x \not \in \FV(\phi) \\
        x \not \in \FV(e)
    }
    {
        \dgthoare {} {\phi} {\sVarAssign{$x$}{$e$}} {\phiAnd{$\phi$}{\phiEq{$x$}{$e$}}}
    }
    
    \inferrule* [right=DGHAssign2]
    {
        \tset{DGHAssign1} \textit{ does not apply}
    }
    {
        \dgthoare {} {\grad{\phi}} {\sVarAssign{$x$}{$e$}} {\qm}
    }
\end{mathpar}
as a sound deterministic lifting.
Note that this lifting is far from optimal, but rather a heuristics.
A stronger lifting requires more sophisticated reasoning.
% MORE expl?