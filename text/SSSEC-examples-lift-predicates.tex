%% phiImplies
\begin{lemma}[Optimal Lifting of Implication]~\\
    Let $\setGFormula$ be extended using the “total unknown” approach (see section \ref{ssec:dedicated-wildcard-formula}).
    Let $~~\gphiImplies{\cdot}{\cdot}~ \subseteq \setGFormula \times \setGFormula$ be defined inductively as
    \begin{mathpar}
        \inferrule* [Right=\gradT ImplStatic]
        {
            \phiImplies{\phi_1}{\phi_2}
        }
        {
            \gphiImplies{\phi_1}{\phi_2}
        }
    \end{mathpar}
    \begin{mathpar}
        \inferrule* [Right=\gradT ImplGrad1]
        {
            \phi \in \setFormulaA
        }
        {
            \gphiImplies{\qm}{\phi}
        }
    \end{mathpar}
    \begin{mathpar}
        \inferrule* [Right=\gradT ImplGrad2]
        {
            ~
        }
        {
            \gphiImplies{\grad{\phi}}{\qm}
        }
    \end{mathpar}
    Then $~\gphiImplies{\cdot}{\cdot}~$ is an optimal lifting of $~\phiImplies{\cdot}{\cdot}~$.
\end{lemma}
\begin{proof}~\\
    Goal:
    $$\gphiImplies{\grad{\phi_1}}{\grad{\phi_2}} \iff \exists \phi_1 \in \gamma(\grad{\phi_1}), \phi_2 \in \gamma(\grad{\phi_2}).~ \phiImplies{\phi_1}{\phi_2}$$
    
    \begin{description}
        \item[Case $\implies$]~\\
        \begin{description}
            \item[Case \tset{\gradT ImplStatic}]
            \begin{align*}
            &\gphiImplies{\phi_1}{\phi_2}\\
            \implies
            &\phiImplies{\phi_1}{\phi_2}\\
            \implies
            &(\exists \phi_1' \in \gamma(\phi_1), \phi_2' \in \gamma(\phi_2).~ \phiImplies{\phi_1'}{\phi_2'})
            \end{align*}
            
            \item[Case \tset{\gradT ImplGrad1}]
            \begin{align*}
            &\gphiImplies{\qm}{\phi}\\
            \implies
            &\phi \in \setFormulaA\\
            \implies
            &(\exists \phi_1 \in \setFormulaA.~ \phiImplies{\phi_1}{\phi})\\
            \implies
            &(\exists \phi_1 \in \gamma(\qm), \phi_2 \in \gamma(\phi).~ \phiImplies{\phi_1}{\phi_2})
            \end{align*}
            
            \item[Case \tset{\gradT ImplGrad2}]
            \begin{align*}
            &\gamma(\grad{\phi}) \neq \emptyset ~\wedge~ \phiTrue \in \gamma(\qm)\\
            \implies
            &(\exists \phi_1 \in \gamma(\grad{\phi}).~ \phiImplies{\phi_1}{\phiTrue}) ~\wedge~ \phiTrue \in \gamma(\qm)\\
            \implies
            &(\exists \phi_1 \in \gamma(\grad{\phi}), \phi_2 \in \gamma(\qm).~ \phiImplies{\phi_1}{\phi_2})
            \end{align*}
        \end{description}
        \item[Case $\impliedby$]~\\
        Given: $\phi_1 \in \gamma(\grad{\phi_1}) \wedge \phi_2 \in \gamma(\grad{\phi_2}) \wedge \phiImplies{\phi_1}{\phi_2}$
        \begin{description}
            \item[Case $\grad{\phi_2} = \qm$]~\\
            Apply $\tset{\gradT ImplGrad2}$.
            
            \item[Case $\grad{\phi_2} = \phi_2 \wedge \grad{\phi_1} = \qm$]
            \begin{align*}
            &\phi_1 \in \gamma(\qm) \wedge \phiImplies{\phi_1}{\phi_2}\\
            \implies
            &\phi_1 \in \setFormulaA \wedge \phiImplies{\phi_1}{\phi_2}\\
            \implies
            &\phi_2 \in \setFormulaA
            \end{align*}
            Apply $\tset{\gradT ImplGrad1}$.
            
            \item[Case $\grad{\phi_2} = \phi_2 \wedge \grad{\phi_1} = \phi_1$]~\\
            Apply $\tset{\gradT ImplStatic}$.
        \end{description}
    \end{description}
\end{proof}

%% evalphi
\begin{lemma}[Optimal Lifting of Evaluation]
    \label{ex:opt-lift-evalphi}~\\
    Let $\setGFormula$ be extended using the “bounded unknown” approach (see section \ref{ssec:wildcard-with-upper}).
    Let $~~\evalgphiGen{\cdot}{\cdot}~ \subseteq \setProgramState \times \setGFormula$ be defined inductively as
    \begin{mathpar}
        \inferrule* [Right=\gradT EvalStatic]
        {
            \evalphiGen{\pi}{\phi}
        }
        {
            \evalgphiGen{\pi}{\phi}
        }
    \end{mathpar}
    \begin{mathpar}
        \inferrule* [Right=\gradT EvalGrad]
        {
            \evalphiGen{\pi}{\phi}
        }
        {
            \evalgphiGen{\pi}{\withqmGen{\phi}}
        }
    \end{mathpar}
    
    Then $~\evalgphiGen{\cdot}{\cdot}~$ is an optimal lifting of $~\evalphiGen{\cdot}{\cdot}~$.
\end{lemma}
\begin{proof}~\\
    Goal:
    $$\evalgphiGen{\pi}{\grad{\phi}} \iff \exists \phi \in \gamma(\grad{\phi}).~ \evalphiGen{\pi}{\phi}$$
    
    \begin{description}
        \item[Case $\implies$]~\\
        \begin{description}
            \item[Case \tset{\gradT EvalStatic}]
            \begin{align*}
            &\evalgphiGen{\pi}{\phi}\\
            \implies
            &\evalphiGen{\pi}{\phi}\\
            \implies
            &(\exists \phi' \in \gamma(\phi).~ \evalphiGen{\pi}{\phi'})
            \end{align*}
            
            \item[Case \tset{\gradT EvalGrad}]
            \begin{align*}
            &\evalgphiGen{\pi}{\withqmGen{\phi}}\\
            \implies
            &\evalphiGen{\pi}{\phi}\\
            \implies
            &(\exists \phi' \in \gamma(\withqmGen{\phi}).~ \evalphiGen{\pi}{\phi'})
            \end{align*}
            
        \end{description}
        \item[Case $\impliedby$]~\\
        Given: $\phi' \in \gamma(\grad{\phi}) \wedge \evalphiGen{\pi}{\phi'}$
        \begin{description}
            \item[Case $\grad{\phi} = \withqmGen{\phi}$] ~\\
            It follows from definition \ref{def:gamma-bounded-unk} that $\phiImplies{\phi'}{\phi}$ and thus $\evalphiGen{\pi}{\phi}$.
            Apply $\tset{\gradT EvalGrad}$.
            \item[Case $\grad{\phi} = \phi$] ~\\
            It follows that $\phi = \phi'$.
            Apply $\tset{\gradT EvalStatic}$.
        \end{description}
    \end{description}
\end{proof}

Note that the definition of lifted evaluation was lifted only w.r.t. the second parameter.
There is no point in lifting evaluation w.r.t. the program state since gradual program state has no impact on evaluation (see lemma \ref{lemma:gradPS-form-sem}).

\begin{comment}
We define denotational semantics of gradual formulas analogous to the non-gradual variant (see definition \ref{def:frm-den-sem}):
\begin{definition}[Denotational Formula Semantics $\envs{\cdot}$ of Gradual Formulas]~\\
    \label{def:gfrm-den-sem}
    Let $\envs{\cdot} : \setGFormula \rightarrow \PP^{\setProgramState}$ be defined as
    \begin{displaymath}
    \envs{\grad{\phi}} \defeq \{~ \pi \in \setProgramState ~|~ \evalgphiGen{\pi}{\grad{\phi}} ~\}
    \end{displaymath}
\end{definition}
\end{comment}

%% composite
\begin{lemma}[Sound Lifting of Composite Predicate]
    \label{lemma:pred-lift-comp}~\\
    Let $P, Q \subseteq \setFormula \times \setFormula$ be arbitrary binary predicates.
    Let $(P \circ Q) \subseteq \setFormula \times \setFormula$ be defined as
    \begin{displaymath}
    (P \circ Q)(\phi_1, \phi_3) ~\defiff~ \exists \phi_2 \in \setFormula.~ P(\phi_1, \phi_2) \wedge Q(\phi_2, \phi_3)
    \end{displaymath}
    
    Let $\grad{(P \circ Q)} \subseteq \setGFormula \times \setGFormula$ be defined as
    \begin{displaymath}
    \grad{(P \circ Q)} ~\defeq~ \grad{P} \circ \grad{Q}
    \end{displaymath}
    with sound liftings $\grad{P}$ and $\grad{Q}$.
    
    Then $\grad{(P \circ Q)}$ is a sound lifting of $(P \circ Q)$, i.e. “piecewise” lifting of composite predicates is allowed.
    Optimality of $\grad{P}$ and $\grad{Q}$ does not imply optimality of $\grad{(P \circ Q)}$.
\end{lemma}
\begin{proof}
    \begin{description}
        \item[Introduction] 
        \begin{align*}
        &(P \circ Q)(\phi_1, \phi_3)\\
        \overset{Definition}{~\quad\quad\implies\quad\quad~}
        &(\exists \phi_2 \in \setFormula.~ P(\phi_1, \phi_2) \wedge Q(\phi_2, \phi_3))\\
        \overset{Introduction}{~\quad\quad\implies\quad\quad~}
        &(\exists \phi_2 \in \setFormula.~ \grad{P}(\phi_1, \phi_2) \wedge \grad{Q}(\phi_2, \phi_3))\\
        \overset{Definition}{~\quad\quad\implies\quad\quad~}
        &(\grad{P} \circ \grad{Q})(\phi_1, \phi_3)\\
        \overset{Definition}{~\quad\quad\implies\quad\quad~}
        &\grad{(P \circ Q)}(\phi_1, \phi_3)\\
        \end{align*}
        
        \item[Monotonicity] 
        \begin{align*}
        &\grad{(P \circ Q)}(\grad{\phi_1}, \grad{\phi_3}) ~\wedge~ \grad{\phi_1} \mpt \grad{\phi_1'} ~\wedge~ \grad{\phi_3} \mpt \grad{\phi_3'}\\
        \overset{Definition}{~\quad\quad\implies\quad\quad~}
        &(\grad{P} \circ \grad{Q})(\grad{\phi_1}, \grad{\phi_3}) ~\wedge~ \grad{\phi_1} \mpt \grad{\phi_1'} ~\wedge~ \grad{\phi_3} \mpt \grad{\phi_3'}\\
        \overset{Definition}{~\quad\quad\implies\quad\quad~}
        &(\exists \grad{\phi_2} \in \setGFormula.~ \grad{P}(\grad{\phi_1}, \grad{\phi_2}) \wedge \grad{Q}(\grad{\phi_2}, \grad{\phi_3})) ~\wedge~ \grad{\phi_1} \mpt \grad{\phi_1'} ~\wedge~ \grad{\phi_3} \mpt \grad{\phi_3'}\\
        \overset{Monotonicity}{~\quad\quad\implies\quad\quad~}
        &(\exists \grad{\phi_2} \in \setGFormula.~ \grad{P}(\grad{\phi_1'}, \grad{\phi_2}) \wedge \grad{Q}(\grad{\phi_2}, \grad{\phi_3'}))\\
        \overset{Definition}{~\quad\quad\implies\quad\quad~}
        &(\grad{P} \circ \grad{Q})(\grad{\phi_1'}, \grad{\phi_3'})\\
        \overset{Definition}{~\quad\quad\implies\quad\quad~}
        &\grad{(P \circ Q)}(\grad{\phi_1'}, \grad{\phi_3'})\\
        \end{align*}
    \end{description}
\end{proof}

%% conjunction
\begin{lemma}[Sound Lifting of Conjunctive Predicate]~\\
    Let $P, Q \subseteq \setFormula$ be arbitrary binary predicates.
    Let $(P \wedge Q) \subseteq \setFormula$ be defined as
    \begin{displaymath}
    (P \wedge Q)(\phi) ~\defiff~ P(\phi) \wedge Q(\phi)
    \end{displaymath}
    
    Let $\grad{(P \wedge Q)} \subseteq \setGFormula$ be defined as
    \begin{displaymath}
    \grad{(P \wedge Q)} ~\defeq~ \grad{P} \wedge \grad{Q}
    \end{displaymath}
    with sound liftings $\grad{P}$ and $\grad{Q}$.
    
    Then $\grad{(P \wedge Q)}$ is a sound lifting of $(P \wedge Q)$, i.e. term-wise lifting of disjunctive predicates is allowed.
    Optimality of $\grad{P}$ and $\grad{Q}$ does not imply optimality of $\grad{(P \wedge Q)}$.
\end{lemma}
\begin{proof}
    \begin{description}
        \item[Introduction] 
        \begin{align*}
        &(P \wedge Q)(\phi)\\
        \overset{Definition}{~\quad\quad\implies\quad\quad~}
        &P(\phi) ~\wedge~ Q(\phi)\\
        \overset{Introduction}{~\quad\quad\implies\quad\quad~}
        &\grad{P}(\phi) ~\wedge~ \grad{Q}(\phi)\\
        \overset{Definition}{~\quad\quad\implies\quad\quad~}
        &(\grad{P} ~\wedge~ \grad{Q})(\phi)\\
        \overset{Definition}{~\quad\quad\implies\quad\quad~}
        &\grad{(P \wedge Q)}(\phi)\\
        \end{align*}
        
        \item[Monotonicity] 
        \begin{align*}
        &(\grad{P} \wedge \grad{Q})(\grad{\phi}) ~\wedge~ \grad{\phi} \mpt \grad{\phi'}\\
        \overset{Definition}{~\quad\quad\implies\quad\quad~}
        &\grad{P}(\grad{\phi}) ~\wedge~ \grad{Q}(\grad{\phi}) ~\wedge~ \grad{\phi} \mpt \grad{\phi'}\\
        \overset{Monotonicity}{~\quad\quad\implies\quad\quad~}
        &\grad{P}(\grad{\phi'}) ~\wedge~ \grad{Q}(\grad{\phi'})\\
        \overset{Definition}{~\quad\quad\implies\quad\quad~}
        &(\grad{P} \wedge \grad{Q})(\grad{\phi'})\\
        \overset{Definition}{~\quad\quad\implies\quad\quad~}
        &\grad{(P \wedge Q)}(\grad{\phi'})\\
        \end{align*}
    \end{description}
\end{proof}

%% disjunction
\begin{lemma}[Optimal Lifting of Disjunctive Predicate]~\\
    Let $P, Q \subseteq \setFormula$ be arbitrary binary predicates.
    Let $(P \vee Q) \subseteq \setFormula$ be defined as
    \begin{displaymath}
    (P \vee Q)(\phi) ~\defiff~ P(\phi) \vee Q(\phi)
    \end{displaymath}
    
    Let $\grad{(P \vee Q)} \subseteq \setGFormula$ be defined as
    \begin{displaymath}
    \grad{(P \vee Q)} ~\defeq~ \grad{P} \vee \grad{Q}
    \end{displaymath}
    with sound liftings $\grad{P}$ and $\grad{Q}$.
    
    Then $\grad{(P \vee Q)}$ is a sound lifting of $(P \vee Q)$, i.e. term-wise lifting of disjunctive predicates is allowed.
    Optimality of $\grad{P}$ and $\grad{Q}$ does imply optimality of $\grad{(P \vee Q)}$.
\end{lemma}
\begin{proof}
    \begin{align*}
    &\grad{(P \vee Q)}(\grad{\phi})\\
    \overset{Definition}{~\quad\quad\iff\quad\quad~}
    &(\grad{P} \vee \grad{Q})(\grad{\phi})\\
    \overset{Definition}{~\quad\quad\iff\quad\quad~}
    &\grad{P}(\grad{\phi}) \vee \grad{Q}(\grad{\phi})\\
    \overset{AGT Def.}{~\quad\quad\iff\quad\quad~}
    &(\exists \phi \in \gamma(\grad{\phi}).~ P(\phi)) \vee (\exists \phi \in \gamma(\grad{\phi}).~ Q(\phi))\\
    \overset{}{~\quad\quad\iff\quad\quad~}
    &(\exists \phi \in \gamma(\grad{\phi}).~ P(\phi) ~\vee~ Q(\phi))\\
    \overset{Definition}{~\quad\quad\iff\quad\quad~}
    &(\exists \phi \in \gamma(\grad{\phi}).~ (P \vee Q)(\phi))
    \end{align*}
\end{proof}

\begin{comment}
We define $\setGFormulaA = \{~ \grad{\phi} \in \setGFormula ~|~ \exists \pi.~ \evalgphiGen {\pi} {\grad{\phi}} ~\}$ as the set of satisfiable gradual formulas.

\begin{lemma}[Restricted Domain of Concretization]~\\
    $\restr{\gamma}{\setGFormulaA}$ never returns the empty set.
\end{lemma}

\end{comment}
